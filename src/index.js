const CronJob = require("cron").CronJob;
const db = require("./database");
const getNewData = require("./request");
const defineNewItems = require("./diff");
const sendEmail = require("./email");

async function init() {
  await db.createConnection();

  const cron = new CronJob(
    "0 0 */1 * * *", //run cron job every hour "0 0 */1 * * *"
    async function () {
      const savedData = await db.getSavedData();

      const newData = await getNewData();
      await db.saveData(newData);

      const newItems = defineNewItems(savedData, newData);

      if (newItems["plugins"].length > 0 || newItems["themes"].length > 0) {
        sendEmail(newItems);
      }

      console.log("newItems", newItems);
    }
  );

  cron.start();
}

init();
