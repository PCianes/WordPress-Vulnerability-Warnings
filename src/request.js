const request = require("request-promise");
const cheerio = require("cheerio");

module.exports = async function getNewData() {
  const baseURL = "https://wpvulndb.com/";
  const plugins = await getTableData(baseURL + "/plugins");
  const themes = await getTableData(baseURL + "/themes");

  return Promise.all([plugins, themes])
    .then((data) => ({
      plugins: data[0],
      themes: data[1],
    }))
    .catch((err) => console.log(err));
};

async function getTableData(url) {
  let data = [];
  try {
    const $ = await requestDataFromUrl(url);
    $("table > tbody > tr").each((i, el) => {
      const td = $(el).find("td");
      data.push({
        name: $(td[0]).text(),
        published: $(td[1]).text(),
        title: $(td[2]).text(),
      });
    });
    return data;
  } catch (error) {
    console.log(error);
  }
}

async function requestDataFromUrl(url) {
  return await request({
    uri: url,
    transform: (body) => cheerio.load(body),
  });
}
