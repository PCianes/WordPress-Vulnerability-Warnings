const sgMail = require("@sendgrid/mail");
require("dotenv").config();

sgMail.setApiKey(process.env.WP_VULN_SENDGRID_API_KEY);

module.exports = function sendEmail(newItems) {
  const email = {
    to: process.env.WP_VULN_TO_EMAIL,
    from: process.env.WP_VULN_FROM_EMAIL,
    subject: "WordPress-Vulnerability-Warnings",
    html: makeReport(newItems),
  };

  sgMail.send(email);
};

function makeReport(newItems) {
  let output = "<h1>New WordPress Vulenaribilities by WPScan</h1>";

  for (const endpoint in newItems) {
    output += `<h2>${endpoint}</h2><ul>`;
    newItems[endpoint].forEach((item) => {
      output += `<li>${item.published} [${item.name}]: ${item.title}</li>`;
    });
    output += `</ul>`;
  }

  return output;
}
